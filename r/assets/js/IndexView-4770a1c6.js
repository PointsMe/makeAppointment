import{u as ie,_ as me}from"./common-7ba2b8f4.js";import{g as pe,a as fe,b as ve,c as ge,d as _e,e as be}from"./common-d105a623.js";import{d as he,r as D,c as Le,a as C,o as De,b as ye,e as V,f as d,w as m,u as we,E as Ce,g as h,h as f,i as S,j as E,F as R,k as M,l as U,m as Y,n as x,p as Ve,q as z,s as xe,t as N,_ as ke}from"./index-48aa1907.js";import{h as Ie}from"./moment-a9aaa855.js";const $e={class:"index-view"},Se={class:"col-content-right"},Ne={key:0,class:"add-server-select"},Ae={class:"add-type"},Oe={class:"back-btn-col-del"},Te={class:"footer-btns"},Ee=he({name:"Index",__name:"IndexView",setup(Re){const k=[{ref:null,id:N(4),itemList:[{id:N(4),label:"类别",value:"type",optionsData:[]},{id:N(4),label:"服务",value:"server",optionsData:[]},{id:N(4),label:"员工",value:"customer",optionsData:[]}],model:{customer:"",type:"",server:""},rules:{type:[{required:!0,message:"请选择类别",trigger:"change"}],server:[{required:!0,message:"请选择服务",trigger:"change"}],customer:[{required:!0,message:"请选择员工",trigger:"change"}]}}],O=ie(),j=D(null),q=D([]),y=D([]),w=D([]),A=D([]),T=we(),F=D(0),B=D(!0),c=D({storeName:"",date:"",time:""}),G=Le(()=>({storeName:[{required:!0,message:"请选择门店",trigger:"change"}],date:[{required:!0,message:"请选择日期",trigger:"change"}],time:[{required:!0,message:"请选择时间",trigger:"change"}]})),s=D(C(k)),J=()=>{let l=!1;for(let e=0;e<s.value.length;e++)Object.keys(s.value[e].model).forEach(t=>{console.log(t,s.value[e].model[t]),s.value[e].model[t]||(l=!0)});if(l)return Y.error("请填写完整信息!!!");const a=C(k).map(e=>(e.itemList=e.itemList.map(t=>(t.value==="type"&&(t.optionsData=y.value),t.value==="customer"&&(t.optionsData=A.value),{...t})),{...e,id:N(4)}));s.value=s.value.concat(a),console.log("addType===>",s.value)},Q=l=>{if(s.value.length===1)return!1;s.value=s.value.filter(a=>a.id!==l)},X=l=>{s.value=s.value.map(a=>{if(a.id===l){const e=N(4),t=`server_${e}`;a.itemList.splice(a.itemList.length-1,0,{id:e,label:"",value:t,optionsData:w.value.filter(i=>i.categoryId===a.model.type)}),a.model[t]=""}return{...a}}),console.log(s.value)},Z=(l,a)=>{s.value=s.value.map(e=>(e.id===l&&(e.itemList=e.itemList.filter(t=>t.id!==a),delete e.model[`server_${a}`]),{...e})),console.log(s.value)},ee=(l,a,e)=>{console.log("changeServer===>",l,a,e,s.value);let t=0;const i=[];if(s.value.forEach(v=>{v.id===a&&(v.model.customer="",Object.keys(v.model).forEach(g=>{if(g.indexOf("server")!==-1){const _=w.value.find(u=>u.value===v.model[g][0]);_&&_.duration&&(t+=_.duration,i.push(_.value))}}))}),!c.value.date||!c.value.time)return Y.error("请填日期与时间!!!"),!1;const o=`${c.value.date} ${c.value.time}`,p=Ie(o).add(t,"minutes").format("YYYY-MM-DD HH:mm:ss");console.log("duration===>",t,i,c.value,new Date(o),new Date(p)),re({startedAt:new Date(o).getTime(),endedAt:new Date(p).getTime(),productIds:i}).then(v=>{s.value=s.value.map(g=>(g.id===a&&(console.log("res===>",v),g.itemList=g.itemList.map(_=>(_.value==="customer"&&(console.log("customer===>",v),_.optionsData=v.map(u=>({...u,name:u.username}))),{..._}))),{...g})),console.log("formList.value===>",s.value)})},P=async()=>{const{data:l}=await pe();console.log("getSettingDetail===>",l),F.value=l.maxReservableDays||0,B.value=l.enabled,B.value||H("当前门店不可预约，请选择其他门店")},H=l=>{Ce.alert(l,"提示",{showClose:!0,confirmButtonText:"OK",showCancelButton:!1,showConfirmButton:!1,callback:a=>{}})},ae=()=>{if(!B.value)return H("当前门店不可预约，请选择其他门店"),!1;j.value.validate(l=>{var a;if(l){let e=!1;for(let o=0;o<s.value.length;o++)Object.keys(s.value[o].model).forEach(p=>{console.log(p,s.value[o].model[p]),s.value[o].model[p]||(e=!0)});if(e)return Y.error("请填写完整信息!!!"),!1;const t=[];C(s.value).map(o=>{Object.keys(o.model).forEach(function(p){p.indexOf("server")!==-1&&(o.model[p].length===1&&t.push({productId:o.model[p][0],brandId:"",employeeId:o.model.customer}),o.model[p].length===2&&t.push({productId:o.model[p][0],brandId:o.model[p][1],employeeId:o.model.customer}))})});const i={params:{predictArrivalAt:new Date(`${c.value.date} ${c.value.time}`).getTime(),productList:t},word:{stormName:(a=q.value.find(o=>o.id===c.value.storeName))==null?void 0:a.name,date:c.value.date,time:c.value.time,list:s.value.map(o=>{var v,g,_;let p=[];return Object.keys(o.model).forEach(function(u){var I,$,n,L;u.indexOf("server")!==-1&&(console.log("key",u,o.model[u]),o.model[u]&&o.model[u].length===1&&p.push(`${(I=w.value.find(r=>r.value===o.model[u][0]))==null?void 0:I.label}`),o.model[u]&&o.model[u].length===2&&p.push(`${($=w.value.find(r=>r.value===o.model[u][0]))==null?void 0:$.label}/${(L=(n=w.value.find(r=>r.value===o.model[u][0]))==null?void 0:n.children.find(r=>r.value===o.model[u][1]))==null?void 0:L.label}`))}),{categoryList:(v=y.value.find(u=>u.id===o.model.type))==null?void 0:v.name,productList:p.join(),customerName:(_=(g=o.itemList.find(u=>u.value==="customer"))==null?void 0:g.optionsData.find(u=>u.id===o.model.customer))==null?void 0:_.name}})}};console.log("请求参数：",s.value,c.value,i),O.setPageOneParamsFn(i),T.push("/User")}else console.log("error submit!!")})},te=()=>{console.log(s.value)},le=l=>{console.log("changeDate=>",l),c.value.date=l,s.value=C(k).map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=y.value),e.value==="customer"&&(e.optionsData=A.value),{...e})),{...a}))},oe=l=>{console.log("changeTime=>",l),c.value.time=l,s.value=C(k).map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=y.value),e.value==="customer"&&(e.optionsData=A.value),{...e})),{...a}))},se=(l,a,e,t)=>{e==="type"&&(console.log("changeType===>",l,a,e,t),s.value=s.value.map(i=>(i.id===a&&(i.itemList=i.itemList.map(o=>(o.value.indexOf("server")!==-1&&(o.optionsData=w.value.filter(p=>p.categoryId===l)),o.value==="customer"&&(o.optionsData=[]),{...o})),Object.keys(i.model).forEach(function(o){i.model.customer="",o.indexOf("server")!==-1&&(i.model[o]="")})),{...i})))},ne=l=>{O.setShopIdFn(l),Promise.all([K(),W(),P()]).then(a=>{console.log(a),s.value=C(k).map(e=>(e.itemList=e.itemList.map(t=>(t.value==="type"&&(t.optionsData=y.value),t.value==="customer"&&(t.optionsData=A.value),{...t})),{...e})),console.log("formList.value===>",s.value)})},K=async()=>{const{data:l}=await fe();return y.value=l,s.value=s.value.map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=y.value),{...e})),{...a})),l},W=async()=>{const{data:l}=await ve(),a=l.map(e=>{var t;return{value:e.id,label:e.brandList&&e.brandList.length>0?`${e.name}`:`${e.name}(€${e.price})`,categoryId:(t=e==null?void 0:e.category)==null?void 0:t.id,duration:e==null?void 0:e.duration,children:e.brandList&&e.brandList.length>0?e.brandList.map(i=>({value:i.id,label:`${i.name}(€${Number(e.price)+Number(i.price)})`})):null}});return w.value=a,l},re=async l=>{const{data:a}=await be(l),e=a.map(t=>({...t,name:t.username}));return A.value=e,a},ue=async()=>{const{data:l}=await ge();q.value=l},de=async l=>{const{data:a}=await _e({code:l});return a};return De(()=>{const l=T.options.history.state.back;console.log("用户是从哪个路由进来的:",T),(l==="/Register"||l==="/register")&&(console.log("用户是从Register路由进来的"),c.value.date="",c.value.time="",s.value=C(k))}),ye(()=>{var a,e;const l=(e=(a=T.currentRoute.value)==null?void 0:a.query)==null?void 0:e.code;l&&de(l).then(t=>{t!=null&&t.merchantId&&(t!=null&&t.id)&&(O.setMerchantIdFn(t.merchantId),O.setShopIdFn(t.id),c.value.storeName=t.id,ue(),K(),W(),P())})}),(l,a)=>{const e=h("el-col"),t=h("el-option"),i=h("el-select"),o=h("el-form-item"),p=h("el-date-picker"),v=h("el-time-select"),g=h("el-form"),_=h("el-cascader"),u=h("el-icon"),I=h("el-button"),$=h("el-row");return f(),V("div",$e,[d($,null,{default:m(()=>[d(e,{span:9},{default:m(()=>a[3]||(a[3]=[S("div",{class:"col-content-left"},[S("img",{src:me,alt:""})],-1)])),_:1,__:[3]}),d(e,{span:6},{default:m(()=>[S("div",Se,[d(g,{ref_key:"formRef",ref:j,"label-position":"top",model:c.value,rules:E(G)},{default:m(()=>[d(o,{label:"门店",prop:"storeName"},{default:m(()=>[d(i,{modelValue:c.value.storeName,"onUpdate:modelValue":a[0]||(a[0]=n=>c.value.storeName=n),placeholder:"请选择门店",onChange:ne},{default:m(()=>[(f(!0),V(R,null,M(q.value,n=>(f(),x(t,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),d(o,{label:"日期与时间",prop:"date"},{default:m(()=>[d(p,{modelValue:c.value.date,"onUpdate:modelValue":a[1]||(a[1]=n=>c.value.date=n),"value-format":"YYYY-MM-DD",style:{width:"100%"},editable:!1,type:"date",onChange:le,placeholder:"请选择日期","disabled-date":n=>{const L=new Date;L.setHours(0,0,0,0);const r=new Date;return r.setHours(0,0,0,0),r.setDate(L.getDate()+F.value),n<L||n>r}},null,8,["modelValue","disabled-date"])]),_:1}),d(o,{label:"",prop:"time"},{default:m(()=>[d(v,{modelValue:c.value.time,"onUpdate:modelValue":a[2]||(a[2]=n=>c.value.time=n),editable:!1,start:"00:00",step:"00:30",end:"23:59",onChange:oe,placeholder:"请选择时间"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),(f(!0),V(R,null,M(s.value,(n,L)=>(f(),V("div",{key:L},[d(g,{ref_for:!0,ref:()=>{n.ref=j.value},"label-position":"top",model:n.model,rules:n.rules},{default:m(()=>[(f(!0),V(R,null,M(n.itemList,(r,ce)=>(f(),x(o,{key:ce,label:r.label},{default:m(()=>[r.value.indexOf("server")!==-1?(f(),V("div",Ne,[d(_,{style:{width:"100%"},modelValue:n.model[r.value],"onUpdate:modelValue":b=>n.model[r.value]=b,options:r.optionsData,placeholder:`请选择${r.label}`,onChange:b=>ee(b,n.id,r.id)},null,8,["modelValue","onUpdate:modelValue","options","placeholder","onChange"]),r.value==="server"&&r.label!==""?(f(),x(u,{key:0,class:"add-server-icon",onClick:b=>X(n.id)},{default:m(()=>[d(E(Ve))]),_:2},1032,["onClick"])):(f(),x(u,{key:1,class:"add-server-icon",onClick:b=>Z(n.id,r.id)},{default:m(()=>[d(E(z))]),_:2},1032,["onClick"]))])):(f(),x(i,{key:1,defaultValue:"",modelValue:n.model[r.value],"onUpdate:modelValue":b=>n.model[r.value]=b,placeholder:`请选择${r.label}`,onChange:b=>se(b,n.id,r.value,n)},{default:m(()=>[(f(!0),V(R,null,M(r.optionsData,b=>(f(),x(t,{key:b.id,label:b.name,value:b.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","onChange"]))]),_:2},1032,["label"]))),128))]),_:2},1032,["model","rules"]),S("div",Ae,[d($,{gutter:24},{default:m(()=>[d(e,{span:12,class:"back-btn-col"},{default:m(()=>[L===0?(f(),x(I,{key:0,class:"back-btn",onClick:J},{default:m(()=>a[4]||(a[4]=[U("添加类别")])),_:1,__:[4]})):xe("",!0)]),_:2},1024),d(e,{span:12},{default:m(()=>[S("div",Oe,[d(u,{class:"add-server-icon",onClick:r=>Q(n.id)},{default:m(()=>[d(E(z))]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024)])]))),128)),S("div",Te,[d($,{gutter:24},{default:m(()=>[d(e,{span:12,class:"back-btn-col"},{default:m(()=>[d(I,{class:"back-btn",onClick:te},{default:m(()=>a[5]||(a[5]=[U("返回")])),_:1,__:[5]})]),_:1}),d(e,{span:12,class:"sure-btn-col"},{default:m(()=>[d(I,{class:"sure-btn",onClick:ae},{default:m(()=>a[6]||(a[6]=[U("确认")])),_:1,__:[6]})]),_:1})]),_:1})])])]),_:1})]),_:1})])}}});const Ue=ke(Ee,[["__scopeId","data-v-87078a02"]]);export{Ue as default};
