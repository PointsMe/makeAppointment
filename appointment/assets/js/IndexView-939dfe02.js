import{u as ne,_ as re}from"./common-096e9932.js";import{a as ue,b as de,c as ce,d as ie}from"./common-c6b9cbbf.js";import{d as me,r as C,c as pe,a as x,o as fe,b as ve,e as I,f as c,w as i,u as ge,g as b,h as g,i as $,j as q,F as E,k as M,l as U,E as Y,m as N,n as _e,p as B,q as O,_ as he}from"./index-2aa5bd53.js";import{h as be}from"./moment-a9aaa855.js";const Le={class:"index-view"},ye={class:"col-content-right"},De={key:0,class:"add-server-select"},Ve={class:"add-type"},Ce={class:"back-btn-col-del"},Ie={class:"footer-btns"},we=me({name:"Index",__name:"IndexView",setup(ke){const S=[{ref:null,id:O(4),itemList:[{id:O(4),label:"类别",value:"type",optionsData:[]},{id:O(4),label:"服务",value:"server",optionsData:[]},{id:O(4),label:"员工",value:"customer",optionsData:[]}],model:{customer:"",type:"",server:""},rules:{type:[{required:!0,message:"请选择类别",trigger:"change"}],server:[{required:!0,message:"请选择服务",trigger:"change"}],customer:[{required:!0,message:"请选择员工",trigger:"change"}]}}],A=ne(),j=C(null),R=C([]),D=C([]),V=C([]),w=C([]),T=ge(),m=C({storeName:"",date:"",time:""}),H=pe(()=>({storeName:[{required:!0,message:"请选择门店",trigger:"change"}],date:[{required:!0,message:"请选择日期",trigger:"change"}],time:[{required:!0,message:"请选择时间",trigger:"change"}]})),o=C(x(S)),W=()=>{let s=!1;for(let e=0;e<o.value.length;e++)Object.keys(o.value[e].model).forEach(t=>{console.log(t,o.value[e].model[t]),o.value[e].model[t]||(s=!0)});if(s)return Y.error("请填写完整信息!!!");const a=x(S).map(e=>(e.itemList=e.itemList.map(t=>(t.value==="type"&&(t.optionsData=D.value),t.value==="customer"&&(t.optionsData=w.value),{...t})),{...e,id:O(4)}));o.value=o.value.concat(a),console.log("addType===>",o.value)},K=s=>{if(o.value.length===1)return!1;o.value=o.value.filter(a=>a.id!==s)},z=s=>{o.value=o.value.map(a=>{if(a.id===s){const e=O(4),t=`server_${e}`;a.itemList.splice(a.itemList.length-1,0,{id:e,label:"",value:t,optionsData:V.value.filter(n=>n.categoryId===a.model.type)}),a.model[t]=""}return{...a}}),console.log(o.value)},G=(s,a)=>{o.value=o.value.map(e=>(e.id===s&&(e.itemList=e.itemList.filter(t=>t.id!==a),delete e.model[`server_${a}`]),{...e})),console.log(o.value)},J=(s,a,e)=>{console.log("changeServer===>",s,a,e,o.value);let t=0;const n=[];if(o.value.forEach(f=>{f.id===a&&(f.model.customer="",Object.keys(f.model).forEach(_=>{if(_.indexOf("server")!==-1){const r=V.value.find(h=>h.value===f.model[_][0]);r&&r.duration&&(t+=r.duration,n.push(r.value))}}))}),!m.value.date||!m.value.time)return Y.error("请填日期与时间!!!"),!1;const l=`${m.value.date} ${m.value.time}`,d=be(l).add(t,"minutes").format("YYYY-MM-DD HH:mm:ss");console.log("duration===>",t,n,m.value,new Date(l),new Date(d)),te({startedAt:new Date(l).getTime(),endedAt:new Date(d).getTime(),productIds:n}).then(f=>{o.value=o.value.map(_=>(_.id===a&&(console.log("res===>",f),_.itemList=_.itemList.map(r=>(r.value==="customer"&&(console.log("customer===>",f),r.optionsData=f.map(h=>({...h,name:h.username}))),{...r}))),{..._})),console.log("formList.value===>",o.value)})},Q=()=>{j.value.validate(s=>{var a;if(s){let e=!1;for(let l=0;l<o.value.length;l++)Object.keys(o.value[l].model).forEach(d=>{console.log(d,o.value[l].model[d]),o.value[l].model[d]||(e=!0)});if(e)return Y.error("请填写完整信息!!!"),!1;const t=[];x(o.value).map(l=>{Object.keys(l.model).forEach(function(d){d.indexOf("server")!==-1&&(l.model[d].length===1&&t.push({productId:l.model[d][0],brandId:"",employeeId:l.model.customer}),l.model[d].length===2&&t.push({productId:l.model[d][0],brandId:l.model[d][1],employeeId:l.model.customer}))})});const n={params:{predictArrivalAt:new Date(`${m.value.date} ${m.value.time}`).getTime(),productList:t},word:{stormName:(a=R.value.find(l=>l.id===m.value.storeName))==null?void 0:a.name,date:m.value.date,time:m.value.time,list:o.value.map(l=>{var f,_;let d=[];return Object.keys(l.model).forEach(function(r){var h,y,k,u;r.indexOf("server")!==-1&&(console.log("key",r,l.model[r]),l.model[r]&&l.model[r].length===1&&d.push(`${(h=V.value.find(L=>L.value===l.model[r][0]))==null?void 0:h.label}`),l.model[r]&&l.model[r].length===2&&d.push(`${(y=V.value.find(L=>L.value===l.model[r][0]))==null?void 0:y.label}/${(u=(k=V.value.find(L=>L.value===l.model[r][0]))==null?void 0:k.children.find(L=>L.value===l.model[r][1]))==null?void 0:u.label}`))}),{categoryList:(f=D.value.find(r=>r.id===l.model.type))==null?void 0:f.name,productList:d.join(),customerName:(_=w.value.find(r=>r.id===l.model.customer))==null?void 0:_.name}})}};console.log("请求参数：",o.value,m.value,n),A.setPageOneParamsFn(n),T.push("/User")}else console.log("error submit!!")})},X=()=>{console.log(o.value)},Z=s=>{console.log("changeDate=>",s),m.value.date=s,o.value=x(S).map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=D.value),e.value==="customer"&&(e.optionsData=w.value),{...e})),{...a}))},ee=s=>{console.log("changeTime=>",s),m.value.time=s,o.value=x(S).map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=D.value),e.value==="customer"&&(e.optionsData=w.value),{...e})),{...a}))},ae=(s,a,e,t)=>{e==="type"&&(console.log("changeType===>",s,a,e,t),o.value=o.value.map(n=>(n.id===a&&(n.itemList=n.itemList.map(l=>(l.value.indexOf("server")!==-1&&(l.optionsData=V.value.filter(d=>d.categoryId===s)),l.value==="customer"&&(l.optionsData=[]),{...l})),Object.keys(n.model).forEach(function(l){n.model.customer="",l.indexOf("server")!==-1&&(n.model[l]="")})),{...n})))},le=s=>{A.setShopIdFn(s),Promise.all([F(),P()]).then(a=>{console.log(a),o.value=x(S).map(e=>(e.itemList=e.itemList.map(t=>(t.value==="type"&&(t.optionsData=D.value),t.value==="customer"&&(t.optionsData=w.value),{...t})),{...e})),console.log("formList.value===>",o.value)})},F=async()=>{const{data:s}=await ue();return D.value=s,o.value=o.value.map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=D.value),{...e})),{...a})),s},P=async()=>{const{data:s}=await de(),a=s.map(e=>{var t;return{value:e.id,label:`${e.name}(€${e.price})`,categoryId:(t=e==null?void 0:e.category)==null?void 0:t.id,duration:e==null?void 0:e.duration,children:e.brandList&&e.brandList.length>0?e.brandList.map(n=>({value:n.id,label:`${n.name}(€${n.price})`})):null}});return V.value=a,s},te=async s=>{const{data:a}=await ie(s),e=a.map(t=>({...t,name:t.username}));return w.value=e,a},oe=async()=>{const{data:s}=await ce();R.value=s};return fe(()=>{console.log("onActivated===>")}),ve(()=>{var e,t,n,l,d;const s=(t=(e=T.currentRoute.value)==null?void 0:e.query)==null?void 0:t.merchantId,a=(l=(n=T.currentRoute.value)==null?void 0:n.query)==null?void 0:l.shopId;console.log("onMounted====>",(d=T.currentRoute.value)==null?void 0:d.query),console.log("onMounted====>"),s&&a&&(A.setMerchantIdFn(s),A.setShopIdFn(a),m.value.storeName=a,oe(),F(),P())}),(s,a)=>{const e=b("el-option"),t=b("el-select"),n=b("el-form-item"),l=b("el-date-picker"),d=b("el-time-select"),f=b("el-form"),_=b("el-cascader"),r=b("el-icon"),h=b("el-button"),y=b("el-col"),k=b("el-row");return g(),I("div",Le,[c(k,null,{default:i(()=>[c(y,{span:24},{default:i(()=>[$("div",ye,[a[6]||(a[6]=$("div",{class:"top-logo"},[$("img",{src:re,alt:""})],-1)),c(f,{ref_key:"formRef",ref:j,"label-position":"top",model:m.value,rules:q(H)},{default:i(()=>[c(n,{label:"门店",prop:"storeName"},{default:i(()=>[c(t,{modelValue:m.value.storeName,"onUpdate:modelValue":a[0]||(a[0]=u=>m.value.storeName=u),placeholder:"请选择门店",onChange:le},{default:i(()=>[(g(!0),I(E,null,M(R.value,u=>(g(),N(e,{key:u.id,label:u.name,value:u.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),c(n,{label:"日期与时间",prop:"date"},{default:i(()=>[c(l,{modelValue:m.value.date,"onUpdate:modelValue":a[1]||(a[1]=u=>m.value.date=u),"value-format":"YYYY-MM-DD",style:{width:"100%"},type:"date",editable:!1,onChange:Z,placeholder:"请选择日期"},null,8,["modelValue"])]),_:1}),c(n,{label:"",prop:"time"},{default:i(()=>[c(d,{modelValue:m.value.time,"onUpdate:modelValue":a[2]||(a[2]=u=>m.value.time=u),start:"00:00",step:"00:30",end:"23:59",editable:!1,onChange:ee,placeholder:"请选择时间"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),(g(!0),I(E,null,M(o.value,(u,L)=>(g(),I("div",{key:L},[c(f,{ref_for:!0,ref:()=>{u.ref=j.value},"label-position":"top",model:u.model,rules:u.rules},{default:i(()=>[(g(!0),I(E,null,M(u.itemList,(p,se)=>(g(),N(n,{key:se,label:p.label},{default:i(()=>[p.value.indexOf("server")!==-1?(g(),I("div",De,[c(_,{style:{width:"100%"},modelValue:u.model[p.value],"onUpdate:modelValue":v=>u.model[p.value]=v,options:p.optionsData,placeholder:"请选择服务",onChange:v=>J(v,u.id,p.id)},null,8,["modelValue","onUpdate:modelValue","options","onChange"]),p.value==="server"&&p.label!==""?(g(),N(r,{key:0,class:"add-server-icon",onClick:v=>z(u.id)},{default:i(()=>[c(q(_e))]),_:2},1032,["onClick"])):(g(),N(r,{key:1,class:"add-server-icon",onClick:v=>G(u.id,p.id)},{default:i(()=>[c(q(B))]),_:2},1032,["onClick"]))])):(g(),N(t,{key:1,defaultValue:"",modelValue:u.model[p.value],"onUpdate:modelValue":v=>u.model[p.value]=v,placeholder:`请选择${p.label}`,onChange:v=>ae(v,u.id,p.value,u)},{default:i(()=>[(g(!0),I(E,null,M(p.optionsData,v=>(g(),N(e,{key:v.id,label:v.name,value:v.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","onChange"]))]),_:2},1032,["label"]))),128))]),_:2},1032,["model","rules"]),$("div",Ve,[c(k,{gutter:24},{default:i(()=>[c(y,{span:12,class:"back-btn-col"},{default:i(()=>[c(h,{class:"back-btn",onClick:W},{default:i(()=>a[3]||(a[3]=[U("添加类别")])),_:1,__:[3]})]),_:1}),c(y,{span:12},{default:i(()=>[$("div",Ce,[c(r,{class:"add-server-icon",onClick:p=>K(u.id)},{default:i(()=>[c(q(B))]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024)])]))),128)),$("div",Ie,[c(k,{gutter:24},{default:i(()=>[c(y,{span:12,class:"back-btn-col"},{default:i(()=>[c(h,{class:"back-btn",onClick:X},{default:i(()=>a[4]||(a[4]=[U("返回")])),_:1,__:[4]})]),_:1}),c(y,{span:12,class:"sure-btn-col"},{default:i(()=>[c(h,{class:"sure-btn",onClick:Q},{default:i(()=>a[5]||(a[5]=[U("确认")])),_:1,__:[5]})]),_:1})]),_:1})])])]),_:1})]),_:1})])}}});const Se=he(we,[["__scopeId","data-v-8d68ed32"]]);export{Se as default};
