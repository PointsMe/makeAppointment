import{u as oe,_ as te}from"./common-708ee2ee.js";import{g as se,a as ne,b as re,c as ue}from"./common-61ca27a9.js";import{d as de,r as V,c as ce,a as U,o as ie,b as me,e as D,f as u,w as c,u as pe,g as L,h as g,i as w,j as q,F as R,k as E,l as Y,m as C,n as fe,p as F,q as k,E as ve,_ as _e}from"./index-01818ce4.js";import{h as ge}from"./moment-a9aaa855.js";const be={class:"index-view"},he={class:"col-content-right"},Le={key:0,class:"add-server-select"},ye={class:"add-type"},Ve={class:"back-btn-col-del"},De={class:"footer-btns"},Ie=de({name:"Index",__name:"IndexView",setup(we){const j=[{ref:null,id:k(4),itemList:[{id:k(4),label:"类别",value:"type",optionsData:[]},{id:k(4),label:"服务",value:"server",optionsData:[]},{id:k(4),label:"员工",value:"customer",optionsData:[]}],model:{customer:"",type:"",server:""},rules:{type:[{required:!0,message:"请选择类别",trigger:"change"}],server:[{required:!0,message:"请选择服务",trigger:"change"}],customer:[{required:!0,message:"请选择员工",trigger:"change"}]}}],$=oe(),M=V(null),T=V([]),x=V([]),y=V([]),S=V([]),N=pe(),v=V({storeName:"",date:"",time:""}),P=ce(()=>({storeName:[{required:!0,message:"请选择门店",trigger:"change"}],date:[{required:!0,message:"请选择日期",trigger:"change"}],time:[{required:!0,message:"请选择时间",trigger:"change"}]})),t=V(U(j)),B=()=>{let s=!1;for(let e=0;e<t.value.length;e++)Object.keys(t.value[e].model).forEach(a=>{console.log(a,t.value[e].model[a]),t.value[e].model[a]||(s=!0)});if(s)return ve.error("请填写完整信息!!!");const l=U(j).map(e=>(e.itemList=e.itemList.map(a=>(a.value==="type"&&(a.optionsData=x.value),a.value==="customer"&&(a.optionsData=S.value),{...a})),{...e,id:k(4)}));t.value=t.value.concat(l),console.log("addType===>",t.value)},H=s=>{if(t.value.length===1)return!1;t.value=t.value.filter(l=>l.id!==s)},W=s=>{t.value=t.value.map(l=>{if(l.id===s){const e=k(4),a=`server_${e}`;l.itemList.splice(l.itemList.length-1,0,{id:e,label:"",value:a,optionsData:y.value.filter(n=>n.categoryId===l.model.type)}),l.model[a]=""}return{...l}}),console.log(t.value)},K=(s,l)=>{t.value=t.value.map(e=>(e.id===s&&(e.itemList=e.itemList.filter(a=>a.id!==l),delete e.model[`server_${l}`]),{...e})),console.log(t.value)},z=(s,l,e)=>{console.log("changeServer===>",s,l,e,t.value);let a=0;const n=[];t.value.forEach(b=>{b.id===l&&Object.keys(b.model).forEach(o=>{if(o.indexOf("server")!==-1){const i=y.value.find(h=>h.value===b.model[o][0]);i&&i.duration&&(a+=i.duration,n.push(i.value))}})});const d=`${v.value.date} ${v.value.time}`,_=ge(d).add(a,"minutes").format("YYYY-MM-DD HH:mm:ss");console.log("duration===>",a,n,v.value,new Date(d),new Date(_)),le({startedAt:new Date(d).getTime(),endedAt:new Date(_).getTime(),productIds:n}).then(b=>{t.value=t.value.map(o=>(o.id===l&&(console.log("res===>",b),o.itemList=o.itemList.map(i=>(i.value==="customer"&&(console.log("customer===>",b),i.optionsData=b.map(h=>({...h,name:h.username}))),{...i}))),{...o})),console.log("formList.value===>",t.value)})},G=()=>{M.value.validate(s=>{if(s){const e=t.value.map(a=>a.ref&&a.ref).map(a=>new Promise(n=>{a?a.validate(d=>{n(d)}):n(!1)}));Promise.all(e).then(a=>{var d;const n=a.every(_=>_===!0);if(console.log("allValid===>",n),n){console.log("allValid",t.value,v.value);const _=[];U(t.value).map(o=>{Object.keys(o.model).forEach(function(i){i.indexOf("server")!==-1&&(o.model[i].length===1&&_.push({productId:o.model[i][0],brandId:"",employeeId:o.model.customer}),o.model[i].length===2&&_.push({productId:o.model[i][0],brandId:o.model[i][1],employeeId:o.model.customer}))})});const b={params:{predictArrivalAt:new Date(`${v.value.date} ${v.value.time}`).getTime(),productList:_},word:{stormName:(d=T.value.find(o=>o.id===v.value.storeName))==null?void 0:d.name,date:v.value.date,time:v.value.time,list:t.value.map(o=>{var h,I;let i=[];return Object.keys(o.model).forEach(function(f){var r,A,m,O;f.indexOf("server")!==-1&&(console.log("key",f,o.model[f]),o.model[f]&&o.model[f].length===1&&i.push(`${(r=y.value.find(p=>p.value===o.model[f][0]))==null?void 0:r.label}`),o.model[f]&&o.model[f].length===2&&i.push(`${(A=y.value.find(p=>p.value===o.model[f][0]))==null?void 0:A.label}/${(O=(m=y.value.find(p=>p.value===o.model[f][0]))==null?void 0:m.children.find(p=>p.value===o.model[f][1]))==null?void 0:O.label}`))}),{categoryList:(h=x.value.find(f=>f.id===o.model.type))==null?void 0:h.name,productList:i.join(),customerName:(I=S.value.find(f=>f.id===o.model.customer))==null?void 0:I.name}})}};console.log("请求参数：",t.value,v.value,b),$.setPageOneParamsFn(b),N.push("/User")}else console.log("Some forms are invalid")})}else console.log("error submit!!")})},J=()=>{console.log(t.value)},Q=(s,l,e,a)=>{e==="type"&&(console.log("changeType===>",s,l,e,a),t.value=t.value.map(n=>(n.id===l&&(n.itemList=n.itemList.map(d=>(d.value.indexOf("server")!==-1&&(d.optionsData=y.value.filter(_=>_.categoryId===s)),{...d})),Object.keys(n.model).forEach(function(d){d.indexOf("server")!==-1&&(n.model[d]="")})),{...n})))},X=s=>{$.setShopIdFn(s),Promise.all([Z(),ee()]).then(l=>{console.log(l),t.value=t.value.map(e=>(e.itemList=e.itemList.map(a=>(a.value==="type"&&(a.optionsData=x.value),a.value==="customer"&&(a.optionsData=S.value),{...a})),{...e})),console.log("formList.value===>",t.value)})},Z=async()=>{const{data:s}=await ne();return x.value=s,s},ee=async()=>{const{data:s}=await re(),l=s.map(e=>{var a;return{value:e.id,label:`${e.name}(€${e.price})`,categoryId:(a=e==null?void 0:e.category)==null?void 0:a.id,duration:e==null?void 0:e.duration,children:e.brandList&&e.brandList.length>0?e.brandList.map(n=>({value:n.id,label:`${n.name}(€${n.price})`})):null}});return y.value=l,s},le=async s=>{const{data:l}=await ue(s),e=l.map(a=>({...a,name:a.username}));return S.value=e,l},ae=async()=>{const{data:s}=await se();T.value=s};return ie(()=>{console.log("onActivated===>")}),me(()=>{var e,a,n,d,_;const s=(a=(e=N.currentRoute.value)==null?void 0:e.query)==null?void 0:a.merchantId,l=(d=(n=N.currentRoute.value)==null?void 0:n.query)==null?void 0:d.shopId;console.log("onMounted====>",(_=N.currentRoute.value)==null?void 0:_.query),s&&l&&($.setMerchantIdFn(s),$.setShopIdFn(l),v.value.storeName=l,ae())}),(s,l)=>{const e=L("el-col"),a=L("el-option"),n=L("el-select"),d=L("el-form-item"),_=L("el-date-picker"),b=L("el-time-select"),o=L("el-form"),i=L("el-cascader"),h=L("el-icon"),I=L("el-button"),f=L("el-row");return g(),D("div",be,[u(f,null,{default:c(()=>[u(e,{span:9},{default:c(()=>l[3]||(l[3]=[w("div",{class:"col-content-left"},[w("img",{src:te,alt:""})],-1)])),_:1,__:[3]}),u(e,{span:6},{default:c(()=>[w("div",he,[u(o,{ref_key:"formRef",ref:M,"label-position":"top",model:v.value,rules:q(P)},{default:c(()=>[u(d,{label:"门店",prop:"storeName"},{default:c(()=>[u(n,{modelValue:v.value.storeName,"onUpdate:modelValue":l[0]||(l[0]=r=>v.value.storeName=r),placeholder:"请选择门店",onChange:X},{default:c(()=>[(g(!0),D(R,null,E(T.value,r=>(g(),C(a,{key:r.id,label:r.name,value:r.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(d,{label:"日期与时间",prop:"date"},{default:c(()=>[u(_,{modelValue:v.value.date,"onUpdate:modelValue":l[1]||(l[1]=r=>v.value.date=r),"value-format":"YYYY-MM-DD",style:{width:"100%"},type:"date",placeholder:"请选择日期"},null,8,["modelValue"])]),_:1}),u(d,{label:"",prop:"time"},{default:c(()=>[u(b,{modelValue:v.value.time,"onUpdate:modelValue":l[2]||(l[2]=r=>v.value.time=r),start:"08:30",step:"00:15",end:"18:30",placeholder:"请选择时间"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),(g(!0),D(R,null,E(t.value,(r,A)=>(g(),D("div",{key:A},[u(o,{ref_for:!0,ref:()=>{r.ref=M.value},"label-position":"top",model:r.model,rules:r.rules},{default:c(()=>[(g(!0),D(R,null,E(r.itemList,(m,O)=>(g(),C(d,{key:O,label:m.label,prop:["type","server","customer"].includes(m.value)?m.value:""},{default:c(()=>[m.value.indexOf("server")!==-1?(g(),D("div",Le,[u(i,{style:{width:"100%"},modelValue:r.model[m.value],"onUpdate:modelValue":p=>r.model[m.value]=p,options:m.optionsData,placeholder:`请选择${m.label}`,onChange:p=>z(p,r.id,m.id)},null,8,["modelValue","onUpdate:modelValue","options","placeholder","onChange"]),m.value==="server"&&m.label!==""?(g(),C(h,{key:0,class:"add-server-icon",onClick:p=>W(r.id)},{default:c(()=>[u(q(fe))]),_:2},1032,["onClick"])):(g(),C(h,{key:1,class:"add-server-icon",onClick:p=>K(r.id,m.id)},{default:c(()=>[u(q(F))]),_:2},1032,["onClick"]))])):(g(),C(n,{key:1,defaultValue:"",modelValue:r.model[m.value],"onUpdate:modelValue":p=>r.model[m.value]=p,placeholder:`请选择${m.label}`,onChange:p=>Q(p,r.id,m.value,r)},{default:c(()=>[(g(!0),D(R,null,E(m.optionsData,p=>(g(),C(a,{key:p.id,label:p.name,value:p.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","onChange"]))]),_:2},1032,["label","prop"]))),128))]),_:2},1032,["model","rules"]),w("div",ye,[u(f,{gutter:24},{default:c(()=>[u(e,{span:12,class:"back-btn-col"},{default:c(()=>[u(I,{class:"back-btn",onClick:B},{default:c(()=>l[4]||(l[4]=[Y("添加类别")])),_:1,__:[4]})]),_:1}),u(e,{span:12},{default:c(()=>[w("div",Ve,[u(h,{class:"add-server-icon",onClick:m=>H(r.id)},{default:c(()=>[u(q(F))]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024)])]))),128)),w("div",De,[u(f,{gutter:24},{default:c(()=>[u(e,{span:12,class:"back-btn-col"},{default:c(()=>[u(I,{class:"back-btn",onClick:J},{default:c(()=>l[5]||(l[5]=[Y("返回")])),_:1,__:[5]})]),_:1}),u(e,{span:12,class:"sure-btn-col"},{default:c(()=>[u(I,{class:"sure-btn",onClick:G},{default:c(()=>l[6]||(l[6]=[Y("确认")])),_:1,__:[6]})]),_:1})]),_:1})])])]),_:1})]),_:1})])}}});const Se=_e(Ie,[["__scopeId","data-v-dcc8bb01"]]);export{Se as default};
