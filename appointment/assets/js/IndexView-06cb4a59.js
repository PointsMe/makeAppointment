import{u as ue,_ as de}from"./common-cbd0af38.js";import{g as ce,a as ie,b as me,c as pe,d as fe}from"./common-84584842.js";import{d as ve,r as D,c as ge,a as $,o as _e,b as be,e as w,f as c,w as i,u as he,g as L,h as v,i as S,j as q,F as E,k as R,l as U,E as Y,m as C,n as Le,p as W,q as De,s as N,_ as ye}from"./index-e2849fbf.js";import{h as Ve}from"./moment-a9aaa855.js";const we={class:"index-view"},Ce={class:"col-content-right"},Ie={key:0,class:"add-server-select"},xe={class:"add-type"},ke={class:"back-btn-col-del"},$e={class:"footer-btns"},Se=ve({name:"Index",__name:"IndexView",setup(Ne){const A=[{ref:null,id:N(4),itemList:[{id:N(4),label:"类别",value:"type",optionsData:[]},{id:N(4),label:"服务",value:"server",optionsData:[]},{id:N(4),label:"员工",value:"customer",optionsData:[]}],model:{customer:"",type:"",server:""},rules:{type:[{required:!0,message:"请选择类别",trigger:"change"}],server:[{required:!0,message:"请选择服务",trigger:"change"}],customer:[{required:!0,message:"请选择员工",trigger:"change"}]}}],O=ue(),M=D(null),j=D([]),y=D([]),V=D([]),I=D([]),T=he(),F=D(0),m=D({storeName:"",date:"",time:""}),K=ge(()=>({storeName:[{required:!0,message:"请选择门店",trigger:"change"}],date:[{required:!0,message:"请选择日期",trigger:"change"}],time:[{required:!0,message:"请选择时间",trigger:"change"}]})),s=D($(A)),z=()=>{let o=!1;for(let e=0;e<s.value.length;e++)Object.keys(s.value[e].model).forEach(l=>{console.log(l,s.value[e].model[l]),s.value[e].model[l]||(o=!0)});if(o)return Y.error("请填写完整信息!!!");const a=$(A).map(e=>(e.itemList=e.itemList.map(l=>(l.value==="type"&&(l.optionsData=y.value),l.value==="customer"&&(l.optionsData=I.value),{...l})),{...e,id:N(4)}));s.value=s.value.concat(a),console.log("addType===>",s.value)},G=o=>{if(s.value.length===1)return!1;s.value=s.value.filter(a=>a.id!==o)},J=o=>{s.value=s.value.map(a=>{if(a.id===o){const e=N(4),l=`server_${e}`;a.itemList.splice(a.itemList.length-1,0,{id:e,label:"",value:l,optionsData:V.value.filter(r=>r.categoryId===a.model.type)}),a.model[l]=""}return{...a}}),console.log(s.value)},Q=(o,a)=>{s.value=s.value.map(e=>(e.id===o&&(e.itemList=e.itemList.filter(l=>l.id!==a),delete e.model[`server_${a}`]),{...e})),console.log(s.value)},X=(o,a,e)=>{console.log("changeServer===>",o,a,e,s.value);let l=0;const r=[];if(s.value.forEach(g=>{g.id===a&&(g.model.customer="",Object.keys(g.model).forEach(_=>{if(_.indexOf("server")!==-1){const u=V.value.find(h=>h.value===g.model[_][0]);u&&u.duration&&(l+=u.duration,r.push(u.value))}}))}),!m.value.date||!m.value.time)return Y.error("请填日期与时间!!!"),!1;const t=`${m.value.date} ${m.value.time}`,d=Ve(t).add(l,"minutes").format("YYYY-MM-DD HH:mm:ss");console.log("duration===>",l,r,m.value,new Date(t),new Date(d)),se({startedAt:new Date(t).getTime(),endedAt:new Date(d).getTime(),productIds:r}).then(g=>{s.value=s.value.map(_=>(_.id===a&&(console.log("res===>",g),_.itemList=_.itemList.map(u=>(u.value==="customer"&&(console.log("customer===>",g),u.optionsData=g.map(h=>({...h,name:h.username}))),{...u}))),{..._})),console.log("formList.value===>",s.value)})},P=async()=>{const{data:o}=await ce();console.log("getSettingDetail===>",o),F.value=o.maxReservableDays||0},Z=()=>{M.value.validate(o=>{var a;if(o){let e=!1;for(let t=0;t<s.value.length;t++)Object.keys(s.value[t].model).forEach(d=>{console.log(d,s.value[t].model[d]),s.value[t].model[d]||(e=!0)});if(e)return Y.error("请填写完整信息!!!"),!1;const l=[];$(s.value).map(t=>{Object.keys(t.model).forEach(function(d){d.indexOf("server")!==-1&&(t.model[d].length===1&&l.push({productId:t.model[d][0],brandId:"",employeeId:t.model.customer}),t.model[d].length===2&&l.push({productId:t.model[d][0],brandId:t.model[d][1],employeeId:t.model.customer}))})});const r={params:{predictArrivalAt:new Date(`${m.value.date} ${m.value.time}`).getTime(),productList:l},word:{stormName:(a=j.value.find(t=>t.id===m.value.storeName))==null?void 0:a.name,date:m.value.date,time:m.value.time,list:s.value.map(t=>{var g,_;let d=[];return Object.keys(t.model).forEach(function(u){var h,x,k,n;u.indexOf("server")!==-1&&(console.log("key",u,t.model[u]),t.model[u]&&t.model[u].length===1&&d.push(`${(h=V.value.find(f=>f.value===t.model[u][0]))==null?void 0:h.label}`),t.model[u]&&t.model[u].length===2&&d.push(`${(x=V.value.find(f=>f.value===t.model[u][0]))==null?void 0:x.label}/${(n=(k=V.value.find(f=>f.value===t.model[u][0]))==null?void 0:k.children.find(f=>f.value===t.model[u][1]))==null?void 0:n.label}`))}),{categoryList:(g=y.value.find(u=>u.id===t.model.type))==null?void 0:g.name,productList:d.join(),customerName:(_=I.value.find(u=>u.id===t.model.customer))==null?void 0:_.name}})}};console.log("请求参数：",s.value,m.value,r),O.setPageOneParamsFn(r),T.push("/User")}else console.log("error submit!!")})},ee=()=>{console.log(s.value)},ae=o=>{console.log("changeDate=>",o),m.value.date=o,s.value=$(A).map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=y.value),e.value==="customer"&&(e.optionsData=I.value),{...e})),{...a}))},te=o=>{console.log("changeTime=>",o),m.value.time=o,s.value=$(A).map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=y.value),e.value==="customer"&&(e.optionsData=I.value),{...e})),{...a}))},le=(o,a,e,l)=>{e==="type"&&(console.log("changeType===>",o,a,e,l),s.value=s.value.map(r=>(r.id===a&&(r.itemList=r.itemList.map(t=>(t.value.indexOf("server")!==-1&&(t.optionsData=V.value.filter(d=>d.categoryId===o)),t.value==="customer"&&(t.optionsData=[]),{...t})),Object.keys(r.model).forEach(function(t){r.model.customer="",t.indexOf("server")!==-1&&(r.model[t]="")})),{...r})))},oe=o=>{O.setShopIdFn(o),Promise.all([B(),H(),P()]).then(a=>{console.log(a),s.value=$(A).map(e=>(e.itemList=e.itemList.map(l=>(l.value==="type"&&(l.optionsData=y.value),l.value==="customer"&&(l.optionsData=I.value),{...l})),{...e})),console.log("formList.value===>",s.value)})},B=async()=>{const{data:o}=await ie();return y.value=o,s.value=s.value.map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=y.value),{...e})),{...a})),o},H=async()=>{const{data:o}=await me(),a=o.map(e=>{var l;return{value:e.id,label:`${e.name}(€${e.price})`,categoryId:(l=e==null?void 0:e.category)==null?void 0:l.id,duration:e==null?void 0:e.duration,children:e.brandList&&e.brandList.length>0?e.brandList.map(r=>({value:r.id,label:`${r.name}(€${r.price})`})):null}});return V.value=a,o},se=async o=>{const{data:a}=await fe(o),e=a.map(l=>({...l,name:l.username}));return I.value=e,a},ne=async()=>{const{data:o}=await pe();j.value=o};return _e(()=>{console.log("onActivated===>")}),be(()=>{var e,l,r,t,d;const o=(l=(e=T.currentRoute.value)==null?void 0:e.query)==null?void 0:l.merchantId,a=(t=(r=T.currentRoute.value)==null?void 0:r.query)==null?void 0:t.shopId;console.log("onMounted====>",(d=T.currentRoute.value)==null?void 0:d.query),o&&a&&(O.setMerchantIdFn(o),O.setShopIdFn(a),m.value.storeName=a,ne(),B(),H(),P())}),(o,a)=>{const e=L("el-col"),l=L("el-option"),r=L("el-select"),t=L("el-form-item"),d=L("el-date-picker"),g=L("el-time-select"),_=L("el-form"),u=L("el-cascader"),h=L("el-icon"),x=L("el-button"),k=L("el-row");return v(),w("div",we,[c(k,null,{default:i(()=>[c(e,{span:9},{default:i(()=>a[3]||(a[3]=[S("div",{class:"col-content-left"},[S("img",{src:de,alt:""})],-1)])),_:1,__:[3]}),c(e,{span:6},{default:i(()=>[S("div",Ce,[c(_,{ref_key:"formRef",ref:M,"label-position":"top",model:m.value,rules:q(K)},{default:i(()=>[c(t,{label:"门店",prop:"storeName"},{default:i(()=>[c(r,{modelValue:m.value.storeName,"onUpdate:modelValue":a[0]||(a[0]=n=>m.value.storeName=n),placeholder:"请选择门店",onChange:oe},{default:i(()=>[(v(!0),w(E,null,R(j.value,n=>(v(),C(l,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),c(t,{label:"日期与时间",prop:"date"},{default:i(()=>[c(d,{modelValue:m.value.date,"onUpdate:modelValue":a[1]||(a[1]=n=>m.value.date=n),"value-format":"YYYY-MM-DD",style:{width:"100%"},editable:!1,type:"date",onChange:ae,placeholder:"请选择日期","disabled-date":n=>{const f=new Date;f.setHours(0,0,0,0);const p=new Date;return p.setHours(0,0,0,0),p.setDate(f.getDate()+F.value),n<f||n>p}},null,8,["modelValue","disabled-date"])]),_:1}),c(t,{label:"",prop:"time"},{default:i(()=>[c(g,{modelValue:m.value.time,"onUpdate:modelValue":a[2]||(a[2]=n=>m.value.time=n),editable:!1,start:"00:00",step:"00:30",end:"23:59",onChange:te,placeholder:"请选择时间"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),(v(!0),w(E,null,R(s.value,(n,f)=>(v(),w("div",{key:f},[c(_,{ref_for:!0,ref:()=>{n.ref=M.value},"label-position":"top",model:n.model,rules:n.rules},{default:i(()=>[(v(!0),w(E,null,R(n.itemList,(p,re)=>(v(),C(t,{key:re,label:p.label},{default:i(()=>[p.value.indexOf("server")!==-1?(v(),w("div",Ie,[c(u,{style:{width:"100%"},modelValue:n.model[p.value],"onUpdate:modelValue":b=>n.model[p.value]=b,options:p.optionsData,placeholder:`请选择${p.label}`,onChange:b=>X(b,n.id,p.id)},null,8,["modelValue","onUpdate:modelValue","options","placeholder","onChange"]),p.value==="server"&&p.label!==""?(v(),C(h,{key:0,class:"add-server-icon",onClick:b=>J(n.id)},{default:i(()=>[c(q(Le))]),_:2},1032,["onClick"])):(v(),C(h,{key:1,class:"add-server-icon",onClick:b=>Q(n.id,p.id)},{default:i(()=>[c(q(W))]),_:2},1032,["onClick"]))])):(v(),C(r,{key:1,defaultValue:"",modelValue:n.model[p.value],"onUpdate:modelValue":b=>n.model[p.value]=b,placeholder:`请选择${p.label}`,onChange:b=>le(b,n.id,p.value,n)},{default:i(()=>[(v(!0),w(E,null,R(p.optionsData,b=>(v(),C(l,{key:b.id,label:b.name,value:b.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","onChange"]))]),_:2},1032,["label"]))),128))]),_:2},1032,["model","rules"]),S("div",xe,[c(k,{gutter:24},{default:i(()=>[c(e,{span:12,class:"back-btn-col"},{default:i(()=>[f===0?(v(),C(x,{key:0,class:"back-btn",onClick:z},{default:i(()=>a[4]||(a[4]=[U("添加类别")])),_:1,__:[4]})):De("",!0)]),_:2},1024),c(e,{span:12},{default:i(()=>[S("div",ke,[c(h,{class:"add-server-icon",onClick:p=>G(n.id)},{default:i(()=>[c(q(W))]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024)])]))),128)),S("div",$e,[c(k,{gutter:24},{default:i(()=>[c(e,{span:12,class:"back-btn-col"},{default:i(()=>[c(x,{class:"back-btn",onClick:ee},{default:i(()=>a[5]||(a[5]=[U("返回")])),_:1,__:[5]})]),_:1}),c(e,{span:12,class:"sure-btn-col"},{default:i(()=>[c(x,{class:"sure-btn",onClick:Z},{default:i(()=>a[6]||(a[6]=[U("确认")])),_:1,__:[6]})]),_:1})]),_:1})])])]),_:1})]),_:1})])}}});const Ee=ye(Se,[["__scopeId","data-v-3b1deafb"]]);export{Ee as default};
