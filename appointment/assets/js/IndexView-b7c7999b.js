import{u as ie,_ as me}from"./common-2384e8a9.js";import{g as pe,a as fe,b as ve,c as ge,d as _e,e as he}from"./common-1cbda76d.js";import{d as be,r as L,c as De,a as C,o as Le,b as ye,e as V,f as u,w as i,u as we,E as Ce,g as D,h as v,i as A,j as T,F as E,k as R,l as B,m as Y,n as x,p as Ve,q as z,s as xe,t as N,_ as Ie}from"./index-9a35dd1a.js";import{h as ke}from"./moment-a9aaa855.js";const $e={class:"index-view"},Se={class:"col-content-right"},Ae={key:0,class:"add-server-select"},Ne={class:"add-type"},Oe={class:"back-btn-col-del"},Te={class:"footer-btns"},Ee=be({name:"Index",__name:"IndexView",setup(Re){const I=[{ref:null,id:N(4),itemList:[{id:N(4),label:"类别",value:"type",optionsData:[]},{id:N(4),label:"服务",value:"server",optionsData:[]},{id:N(4),label:"员工",value:"customer",optionsData:[]}],model:{customer:"",type:"",server:""},rules:{type:[{required:!0,message:"请选择类别",trigger:"change"}],server:[{required:!0,message:"请选择服务",trigger:"change"}],customer:[{required:!0,message:"请选择员工",trigger:"change"}]}}],O=ie(),M=L(null),U=L([]),y=L([]),w=L([]),k=L([]),j=we(),F=L(0),q=L(!0),d=L({storeName:"",date:"",time:""}),G=De(()=>({storeName:[{required:!0,message:"请选择门店",trigger:"change"}],date:[{required:!0,message:"请选择日期",trigger:"change"}],time:[{required:!0,message:"请选择时间",trigger:"change"}]})),s=L(C(I)),J=()=>{let t=!1;for(let e=0;e<s.value.length;e++)Object.keys(s.value[e].model).forEach(l=>{console.log(l,s.value[e].model[l]),s.value[e].model[l]||(t=!0)});if(t)return Y.error("请填写完整信息!!!");const a=C(I).map(e=>(e.itemList=e.itemList.map(l=>(l.value==="type"&&(l.optionsData=y.value),l.value==="customer"&&(l.optionsData=k.value),{...l})),{...e,id:N(4)}));s.value=s.value.concat(a),console.log("addType===>",s.value)},Q=t=>{if(s.value.length===1)return!1;s.value=s.value.filter(a=>a.id!==t)},X=t=>{s.value=s.value.map(a=>{if(a.id===t){const e=N(4),l=`server_${e}`;a.itemList.splice(a.itemList.length-1,0,{id:e,label:"",value:l,optionsData:w.value.filter(c=>c.categoryId===a.model.type)}),a.model[l]=""}return{...a}}),console.log(s.value)},Z=(t,a)=>{s.value=s.value.map(e=>(e.id===t&&(e.itemList=e.itemList.filter(l=>l.id!==a),delete e.model[`server_${a}`]),{...e})),console.log(s.value)},ee=(t,a,e)=>{console.log("changeServer===>",t,a,e,s.value);let l=0;const c=[];if(s.value.forEach(g=>{g.id===a&&(g.model.customer="",Object.keys(g.model).forEach(_=>{if(_.indexOf("server")!==-1){const r=w.value.find(b=>b.value===g.model[_][0]);r&&r.duration&&(l+=r.duration,c.push(r.value))}}))}),!d.value.date||!d.value.time)return Y.error("请填日期与时间!!!"),!1;const o=`${d.value.date} ${d.value.time}`,m=ke(o).add(l,"minutes").format("YYYY-MM-DD HH:mm:ss");console.log("duration===>",l,c,d.value,new Date(o),new Date(m)),re({startedAt:new Date(o).getTime(),endedAt:new Date(m).getTime(),productIds:c}).then(g=>{s.value=s.value.map(_=>(_.id===a&&(console.log("res===>",g),_.itemList=_.itemList.map(r=>(r.value==="customer"&&(console.log("customer===>",g),r.optionsData=g.map(b=>({...b,name:b.username}))),{...r}))),{..._})),console.log("formList.value===>",s.value)})},P=async()=>{const{data:t}=await pe();console.log("getSettingDetail===>",t),F.value=t.maxReservableDays||0,q.value=t.enabled,q.value||H("当前门店不可预约，请选择其他门店")},H=t=>{Ce.alert(t,"提示",{showClose:!0,confirmButtonText:"OK",showCancelButton:!1,showConfirmButton:!1,callback:a=>{}})},ae=()=>{if(!q.value)return H("当前门店不可预约，请选择其他门店"),!1;M.value.validate(t=>{var a;if(t){let e=!1;for(let o=0;o<s.value.length;o++)Object.keys(s.value[o].model).forEach(m=>{console.log(m,s.value[o].model[m]),s.value[o].model[m]||(e=!0)});if(e)return Y.error("请填写完整信息!!!"),!1;const l=[];C(s.value).map(o=>{Object.keys(o.model).forEach(function(m){m.indexOf("server")!==-1&&(o.model[m].length===1&&l.push({productId:o.model[m][0],brandId:"",employeeId:o.model.customer}),o.model[m].length===2&&l.push({productId:o.model[m][0],brandId:o.model[m][1],employeeId:o.model.customer}))})});const c={params:{predictArrivalAt:new Date(`${d.value.date} ${d.value.time}`).getTime(),productList:l},word:{stormName:(a=U.value.find(o=>o.id===d.value.storeName))==null?void 0:a.name,date:d.value.date,time:d.value.time,list:s.value.map(o=>{var g,_;let m=[];return Object.keys(o.model).forEach(function(r){var b,$,S,n;r.indexOf("server")!==-1&&(console.log("key",r,o.model[r]),o.model[r]&&o.model[r].length===1&&m.push(`${(b=w.value.find(f=>f.value===o.model[r][0]))==null?void 0:b.label}`),o.model[r]&&o.model[r].length===2&&m.push(`${($=w.value.find(f=>f.value===o.model[r][0]))==null?void 0:$.label}/${(n=(S=w.value.find(f=>f.value===o.model[r][0]))==null?void 0:S.children.find(f=>f.value===o.model[r][1]))==null?void 0:n.label}`))}),{categoryList:(g=y.value.find(r=>r.id===o.model.type))==null?void 0:g.name,productList:m.join(),customerName:(_=k.value.find(r=>r.id===o.model.customer))==null?void 0:_.name}})}};console.log("请求参数：",s.value,d.value,c),O.setPageOneParamsFn(c),j.push("/User")}else console.log("error submit!!")})},te=()=>{console.log(s.value)},le=t=>{console.log("changeDate=>",t),d.value.date=t,s.value=C(I).map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=y.value),e.value==="customer"&&(e.optionsData=k.value),{...e})),{...a}))},oe=t=>{console.log("changeTime=>",t),d.value.time=t,s.value=C(I).map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=y.value),e.value==="customer"&&(e.optionsData=k.value),{...e})),{...a}))},se=(t,a,e,l)=>{e==="type"&&(console.log("changeType===>",t,a,e,l),s.value=s.value.map(c=>(c.id===a&&(c.itemList=c.itemList.map(o=>(o.value.indexOf("server")!==-1&&(o.optionsData=w.value.filter(m=>m.categoryId===t)),o.value==="customer"&&(o.optionsData=[]),{...o})),Object.keys(c.model).forEach(function(o){c.model.customer="",o.indexOf("server")!==-1&&(c.model[o]="")})),{...c})))},ne=t=>{O.setShopIdFn(t),Promise.all([K(),W(),P()]).then(a=>{console.log(a),s.value=C(I).map(e=>(e.itemList=e.itemList.map(l=>(l.value==="type"&&(l.optionsData=y.value),l.value==="customer"&&(l.optionsData=k.value),{...l})),{...e})),console.log("formList.value===>",s.value)})},K=async()=>{const{data:t}=await fe();return y.value=t,s.value=s.value.map(a=>(a.itemList=a.itemList.map(e=>(e.value==="type"&&(e.optionsData=y.value),{...e})),{...a})),t},W=async()=>{const{data:t}=await ve(),a=t.map(e=>{var l;return{value:e.id,label:`${e.name}(€${e.price})`,categoryId:(l=e==null?void 0:e.category)==null?void 0:l.id,duration:e==null?void 0:e.duration,children:e.brandList&&e.brandList.length>0?e.brandList.map(c=>({value:c.id,label:`${c.name}(€${c.price})`})):null}});return w.value=a,t},re=async t=>{const{data:a}=await he(t),e=a.map(l=>({...l,name:l.username}));return k.value=e,a},ue=async()=>{const{data:t}=await ge();U.value=t},de=async t=>{const{data:a}=await _e({code:t});return a};return Le(()=>{const t=j.options.history.state.forward;console.log("用户是从哪个路由进来的:",t),(t==="/register"||t==="/Register")&&(console.log("用户是从User路由进来的"),d.value.date="",d.value.time="",s.value=C(I))}),ye(()=>{var a,e;const t=(e=(a=j.currentRoute.value)==null?void 0:a.query)==null?void 0:e.code;t&&de(t).then(l=>{l!=null&&l.merchantId&&(l!=null&&l.id)&&(O.setMerchantIdFn(l.merchantId),O.setShopIdFn(l.id),d.value.storeName=l.id,ue(),K(),W(),P())})}),(t,a)=>{const e=D("el-col"),l=D("el-option"),c=D("el-select"),o=D("el-form-item"),m=D("el-date-picker"),g=D("el-time-select"),_=D("el-form"),r=D("el-cascader"),b=D("el-icon"),$=D("el-button"),S=D("el-row");return v(),V("div",$e,[u(S,null,{default:i(()=>[u(e,{span:9},{default:i(()=>a[3]||(a[3]=[A("div",{class:"col-content-left"},[A("img",{src:me,alt:""})],-1)])),_:1,__:[3]}),u(e,{span:6},{default:i(()=>[A("div",Se,[u(_,{ref_key:"formRef",ref:M,"label-position":"top",model:d.value,rules:T(G)},{default:i(()=>[u(o,{label:"门店",prop:"storeName"},{default:i(()=>[u(c,{modelValue:d.value.storeName,"onUpdate:modelValue":a[0]||(a[0]=n=>d.value.storeName=n),placeholder:"请选择门店",onChange:ne},{default:i(()=>[(v(!0),V(E,null,R(U.value,n=>(v(),x(l,{key:n.id,label:n.name,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(o,{label:"日期与时间",prop:"date"},{default:i(()=>[u(m,{modelValue:d.value.date,"onUpdate:modelValue":a[1]||(a[1]=n=>d.value.date=n),"value-format":"YYYY-MM-DD",style:{width:"100%"},editable:!1,type:"date",onChange:le,placeholder:"请选择日期","disabled-date":n=>{const f=new Date;f.setHours(0,0,0,0);const p=new Date;return p.setHours(0,0,0,0),p.setDate(f.getDate()+F.value),n<f||n>p}},null,8,["modelValue","disabled-date"])]),_:1}),u(o,{label:"",prop:"time"},{default:i(()=>[u(g,{modelValue:d.value.time,"onUpdate:modelValue":a[2]||(a[2]=n=>d.value.time=n),editable:!1,start:"00:00",step:"00:30",end:"23:59",onChange:oe,placeholder:"请选择时间"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),(v(!0),V(E,null,R(s.value,(n,f)=>(v(),V("div",{key:f},[u(_,{ref_for:!0,ref:()=>{n.ref=M.value},"label-position":"top",model:n.model,rules:n.rules},{default:i(()=>[(v(!0),V(E,null,R(n.itemList,(p,ce)=>(v(),x(o,{key:ce,label:p.label},{default:i(()=>[p.value.indexOf("server")!==-1?(v(),V("div",Ae,[u(r,{style:{width:"100%"},modelValue:n.model[p.value],"onUpdate:modelValue":h=>n.model[p.value]=h,options:p.optionsData,placeholder:`请选择${p.label}`,onChange:h=>ee(h,n.id,p.id)},null,8,["modelValue","onUpdate:modelValue","options","placeholder","onChange"]),p.value==="server"&&p.label!==""?(v(),x(b,{key:0,class:"add-server-icon",onClick:h=>X(n.id)},{default:i(()=>[u(T(Ve))]),_:2},1032,["onClick"])):(v(),x(b,{key:1,class:"add-server-icon",onClick:h=>Z(n.id,p.id)},{default:i(()=>[u(T(z))]),_:2},1032,["onClick"]))])):(v(),x(c,{key:1,defaultValue:"",modelValue:n.model[p.value],"onUpdate:modelValue":h=>n.model[p.value]=h,placeholder:`请选择${p.label}`,onChange:h=>se(h,n.id,p.value,n)},{default:i(()=>[(v(!0),V(E,null,R(p.optionsData,h=>(v(),x(l,{key:h.id,label:h.name,value:h.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","onChange"]))]),_:2},1032,["label"]))),128))]),_:2},1032,["model","rules"]),A("div",Ne,[u(S,{gutter:24},{default:i(()=>[u(e,{span:12,class:"back-btn-col"},{default:i(()=>[f===0?(v(),x($,{key:0,class:"back-btn",onClick:J},{default:i(()=>a[4]||(a[4]=[B("添加类别")])),_:1,__:[4]})):xe("",!0)]),_:2},1024),u(e,{span:12},{default:i(()=>[A("div",Oe,[u(b,{class:"add-server-icon",onClick:p=>Q(n.id)},{default:i(()=>[u(T(z))]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024)])]))),128)),A("div",Te,[u(S,{gutter:24},{default:i(()=>[u(e,{span:12,class:"back-btn-col"},{default:i(()=>[u($,{class:"back-btn",onClick:te},{default:i(()=>a[5]||(a[5]=[B("返回")])),_:1,__:[5]})]),_:1}),u(e,{span:12,class:"sure-btn-col"},{default:i(()=>[u($,{class:"sure-btn",onClick:ae},{default:i(()=>a[6]||(a[6]=[B("确认")])),_:1,__:[6]})]),_:1})]),_:1})])])]),_:1})]),_:1})])}}});const Be=Ie(Ee,[["__scopeId","data-v-5ce95077"]]);export{Be as default};
