import{u as oe,_ as te}from"./common-708ee2ee.js";import{g as se,a as ne,b as re,c as ue}from"./common-61ca27a9.js";import{d as de,r as D,c as ce,a as U,o as ie,b as me,e as I,f as u,w as c,u as pe,g as L,h as b,i as w,j as q,F as R,k as E,l as Y,m as C,n as fe,p as F,q as k,E as ve,_ as ge}from"./index-01818ce4.js";import{h as _e}from"./moment-a9aaa855.js";const be={class:"index-view"},he={class:"col-content-right"},Le={key:0,class:"add-server-select"},ye={class:"add-type"},Ve={class:"back-btn-col-del"},De={class:"footer-btns"},Ie=de({name:"Index",__name:"IndexView",setup(we){const j=[{ref:null,id:k(4),itemList:[{id:k(4),label:"类别",value:"type",optionsData:[]},{id:k(4),label:"服务",value:"server",optionsData:[]},{id:k(4),label:"员工",value:"customer",optionsData:[]}],model:{customer:"",type:"",server:""},rules:{type:[{required:!0,message:"请选择类别",trigger:"change"}],server:[{required:!0,message:"请选择服务",trigger:"change"}],customer:[{required:!0,message:"请选择员工",trigger:"change"}]}}],x=oe(),M=D(null),T=D([]),$=D([]),V=D([]),S=D([]),N=pe(),v=D({storeName:"",date:"",time:""}),P=ce(()=>({storeName:[{required:!0,message:"请选择门店",trigger:"change"}],date:[{required:!0,message:"请选择日期",trigger:"change"}],time:[{required:!0,message:"请选择时间",trigger:"change"}]})),o=D(U(j)),B=()=>{let s=!1;for(let e=0;e<o.value.length;e++)Object.keys(o.value[e].model).forEach(a=>{console.log(a,o.value[e].model[a]),o.value[e].model[a]||(s=!0)});if(s)return ve.error("请填写完整信息!!!");const l=U(j).map(e=>(e.itemList=e.itemList.map(a=>(a.value==="type"&&(a.optionsData=$.value),a.value==="customer"&&(a.optionsData=S.value),{...a})),{...e,id:k(4)}));o.value=o.value.concat(l),console.log("addType===>",o.value)},H=s=>{if(o.value.length===1)return!1;o.value=o.value.filter(l=>l.id!==s)},W=s=>{o.value=o.value.map(l=>{if(l.id===s){const e=k(4),a=`server_${e}`;l.itemList.splice(l.itemList.length-1,0,{id:e,label:"",value:a,optionsData:V.value.filter(n=>n.categoryId===l.model.type)}),l.model[a]=""}return{...l}}),console.log(o.value)},K=(s,l)=>{o.value=o.value.map(e=>(e.id===s&&(e.itemList=e.itemList.filter(a=>a.id!==l),delete e.model[`server_${l}`]),{...e})),console.log(o.value)},z=(s,l,e)=>{console.log("changeServer===>",s,l,e,o.value);let a=0;const n=[];o.value.forEach(_=>{_.id===l&&Object.keys(_.model).forEach(t=>{if(t.indexOf("server")!==-1){const d=V.value.find(h=>h.value===_.model[t][0]);d&&d.duration&&(a+=d.duration,n.push(d.value))}})});const m=`${v.value.date} ${v.value.time}`,g=_e(m).add(a,"minutes").format("YYYY-MM-DD HH:mm:ss");console.log("duration===>",a,n,v.value,new Date(m),new Date(g)),le({startedAt:new Date(m).getTime(),endedAt:new Date(g).getTime(),productIds:n}).then(_=>{o.value=o.value.map(t=>(t.id===l&&(console.log("res===>",_),t.itemList=t.itemList.map(d=>(d.value==="customer"&&(console.log("customer===>",_),d.optionsData=_.map(h=>({...h,name:h.username}))),{...d}))),{...t})),console.log("formList.value===>",o.value)})},G=()=>{M.value.validate(s=>{if(s){const e=o.value.map(a=>a.ref&&a.ref).map(a=>new Promise(n=>{a?a.validate(m=>{n(m)}):n(!1)}));Promise.all(e).then(a=>{var m;const n=a.every(g=>g===!0);if(console.log("allValid===>",n),n){console.log("allValid",o.value,v.value);const g=[];U(o.value).map(t=>{Object.keys(t.model).forEach(function(d){d.indexOf("server")!==-1&&(t.model[d].length===1&&g.push({productId:t.model[d][0],brandId:"",employeeId:t.model.customer}),t.model[d].length===2&&g.push({productId:t.model[d][0],brandId:t.model[d][1],employeeId:t.model.customer}))})});const _={params:{predictArrivalAt:new Date(`${v.value.date} ${v.value.time}`).getTime(),productList:g},word:{stormName:(m=T.value.find(t=>t.id===v.value.storeName))==null?void 0:m.name,date:v.value.date,time:v.value.time,list:o.value.map(t=>{var h,y;let d=[];return Object.keys(t.model).forEach(function(f){var r,A,p,O;f.indexOf("server")!==-1&&(console.log("key",f,t.model[f]),t.model[f]&&t.model[f].length===1&&d.push(`${(r=V.value.find(i=>i.value===t.model[f][0]))==null?void 0:r.label}`),t.model[f]&&t.model[f].length===2&&d.push(`${(A=V.value.find(i=>i.value===t.model[f][0]))==null?void 0:A.label}/${(O=(p=V.value.find(i=>i.value===t.model[f][0]))==null?void 0:p.children.find(i=>i.value===t.model[f][1]))==null?void 0:O.label}`))}),{categoryList:(h=$.value.find(f=>f.id===t.model.type))==null?void 0:h.name,productList:d.join(),customerName:(y=S.value.find(f=>f.id===t.model.customer))==null?void 0:y.name}})}};console.log("请求参数：",o.value,v.value,_),x.setPageOneParamsFn(_),N.push("/User")}else console.log("Some forms are invalid")})}else console.log("error submit!!")})},J=()=>{console.log(o.value)},Q=(s,l,e,a)=>{e==="type"&&(console.log("changeType===>",s,l,e,a),o.value=o.value.map(n=>(n.id===l&&(n.itemList=n.itemList.map(m=>(m.value.indexOf("server")!==-1&&(m.optionsData=V.value.filter(g=>g.categoryId===s)),{...m})),Object.keys(n.model).forEach(function(m){m.indexOf("server")!==-1&&(n.model[m]="")})),{...n})))},X=s=>{x.setShopIdFn(s),Promise.all([Z(),ee()]).then(l=>{console.log(l),o.value=o.value.map(e=>(e.itemList=e.itemList.map(a=>(a.value==="type"&&(a.optionsData=$.value),a.value==="customer"&&(a.optionsData=S.value),{...a})),{...e})),console.log("formList.value===>",o.value)})},Z=async()=>{const{data:s}=await ne();return $.value=s,s},ee=async()=>{const{data:s}=await re(),l=s.map(e=>{var a;return{value:e.id,label:`${e.name}(€${e.price})`,categoryId:(a=e==null?void 0:e.category)==null?void 0:a.id,duration:e==null?void 0:e.duration,children:e.brandList&&e.brandList.length>0?e.brandList.map(n=>({value:n.id,label:`${n.name}(€${n.price})`})):null}});return V.value=l,s},le=async s=>{const{data:l}=await ue(s),e=l.map(a=>({...a,name:a.username}));return S.value=e,l},ae=async()=>{const{data:s}=await se();T.value=s};return ie(()=>{console.log("onActivated===>")}),me(()=>{var e,a,n,m,g;const s=(a=(e=N.currentRoute.value)==null?void 0:e.query)==null?void 0:a.merchantId,l=(m=(n=N.currentRoute.value)==null?void 0:n.query)==null?void 0:m.shopId;console.log("onMounted====>",(g=N.currentRoute.value)==null?void 0:g.query),s&&l&&(x.setMerchantIdFn(s),x.setShopIdFn(l),v.value.storeName=l,ae())}),(s,l)=>{const e=L("el-option"),a=L("el-select"),n=L("el-form-item"),m=L("el-date-picker"),g=L("el-time-select"),_=L("el-form"),t=L("el-cascader"),d=L("el-icon"),h=L("el-button"),y=L("el-col"),f=L("el-row");return b(),I("div",be,[u(f,null,{default:c(()=>[u(y,{span:24},{default:c(()=>[w("div",he,[l[6]||(l[6]=w("div",{class:"top-logo"},[w("img",{src:te,alt:""})],-1)),u(_,{ref_key:"formRef",ref:M,"label-position":"top",model:v.value,rules:q(P)},{default:c(()=>[u(n,{label:"门店",prop:"storeName"},{default:c(()=>[u(a,{modelValue:v.value.storeName,"onUpdate:modelValue":l[0]||(l[0]=r=>v.value.storeName=r),placeholder:"请选择门店",onChange:X},{default:c(()=>[(b(!0),I(R,null,E(T.value,r=>(b(),C(e,{key:r.id,label:r.name,value:r.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),u(n,{label:"日期与时间",prop:"date"},{default:c(()=>[u(m,{modelValue:v.value.date,"onUpdate:modelValue":l[1]||(l[1]=r=>v.value.date=r),"value-format":"YYYY-MM-DD",style:{width:"100%"},type:"date",editable:!1,placeholder:"请选择日期"},null,8,["modelValue"])]),_:1}),u(n,{label:"",prop:"time"},{default:c(()=>[u(g,{modelValue:v.value.time,"onUpdate:modelValue":l[2]||(l[2]=r=>v.value.time=r),start:"08:30",step:"00:15",end:"18:30",editable:!1,placeholder:"请选择时间"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),(b(!0),I(R,null,E(o.value,(r,A)=>(b(),I("div",{key:A},[u(_,{ref_for:!0,ref:()=>{r.ref=M.value},"label-position":"top",model:r.model,rules:r.rules},{default:c(()=>[(b(!0),I(R,null,E(r.itemList,(p,O)=>(b(),C(n,{key:O,label:p.label,prop:["type","server","customer"].includes(p.value)?p.value:""},{default:c(()=>[p.value.indexOf("server")!==-1?(b(),I("div",Le,[u(t,{style:{width:"100%"},modelValue:r.model[p.value],"onUpdate:modelValue":i=>r.model[p.value]=i,options:p.optionsData,placeholder:"请选择服务",onChange:i=>z(i,r.id,p.id)},null,8,["modelValue","onUpdate:modelValue","options","onChange"]),p.value==="server"&&p.label!==""?(b(),C(d,{key:0,class:"add-server-icon",onClick:i=>W(r.id)},{default:c(()=>[u(q(fe))]),_:2},1032,["onClick"])):(b(),C(d,{key:1,class:"add-server-icon",onClick:i=>K(r.id,p.id)},{default:c(()=>[u(q(F))]),_:2},1032,["onClick"]))])):(b(),C(a,{key:1,defaultValue:"",modelValue:r.model[p.value],"onUpdate:modelValue":i=>r.model[p.value]=i,placeholder:`请选择${p.label}`,onChange:i=>Q(i,r.id,p.value,r)},{default:c(()=>[(b(!0),I(R,null,E(p.optionsData,i=>(b(),C(e,{key:i.id,label:i.name,value:i.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","onChange"]))]),_:2},1032,["label","prop"]))),128))]),_:2},1032,["model","rules"]),w("div",ye,[u(f,{gutter:24},{default:c(()=>[u(y,{span:12,class:"back-btn-col"},{default:c(()=>[u(h,{class:"back-btn",onClick:B},{default:c(()=>l[3]||(l[3]=[Y("添加类别")])),_:1,__:[3]})]),_:1}),u(y,{span:12},{default:c(()=>[w("div",Ve,[u(d,{class:"add-server-icon",onClick:p=>H(r.id)},{default:c(()=>[u(q(F))]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024)])]))),128)),w("div",De,[u(f,{gutter:24},{default:c(()=>[u(y,{span:12,class:"back-btn-col"},{default:c(()=>[u(h,{class:"back-btn",onClick:J},{default:c(()=>l[4]||(l[4]=[Y("返回")])),_:1,__:[4]})]),_:1}),u(y,{span:12,class:"sure-btn-col"},{default:c(()=>[u(h,{class:"sure-btn",onClick:G},{default:c(()=>l[5]||(l[5]=[Y("确认")])),_:1,__:[5]})]),_:1})]),_:1})])])]),_:1})]),_:1})])}}});const Se=ge(Ie,[["__scopeId","data-v-ee04f27a"]]);export{Se as default};
